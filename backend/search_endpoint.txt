
@app.post("/search")
def search_youtube(request: SearchRequest):
    """
    Busca vídeos no YouTube
    """
    try:
        query = request.query
        print(f"Searching for: {query}")
        
        ydl_opts = {
            'default_search': 'ytsearch10', # Buscar top 10
            'quiet': True,
            'nocheckcertificate': True,
            'ignoreerrors': True,
            'no_warnings': True,
            'extract_flat': True, # Metadados rápidos
            'cookiefile': os.path.join(get_base_dir(), 'cookies.txt'),
        }
        
        # Tentar rotação de clientes para busca também
        clients = ['web', 'android'] 
        info = None
        
        for client in clients:
            try:
                if client == 'web':
                   if 'extractor_args' in ydl_opts: del ydl_opts['extractor_args']
                else:
                    ydl_opts['extractor_args'] = {'youtube': {'player_client': [client]}}
                    
                with yt_dlp.YoutubeDL(ydl_opts) as ydl:
                    info = ydl.extract_info(f"ytsearch10:{query}", download=False)
                break # Sucesso
            except Exception:
                continue

        results = []
        if info and 'entries' in info:
            for entry in info['entries']:
                if not entry: continue
                
                # Thumbnails extraction logic
                thumb = None
                if entry.get('thumbnails'):
                    try:
                         thumb = entry['thumbnails'][-1]['url']
                    except: pass
                elif entry.get('thumbnail'):
                    thumb = entry['thumbnail']

                # Duration formatting
                duration = entry.get('duration')
                duration_str = "0:00"
                if duration:
                    import datetime
                    duration_str = str(datetime.timedelta(seconds=duration))
                    if duration_str.startswith('0:'): duration_str = duration_str[2:]
                
                results.append({
                    'id': entry.get('id'),
                    'title': entry.get('title'),
                    'thumbnail': thumb,
                    'uploader': entry.get('uploader'),
                    'duration': duration,
                    'duration_string': duration_str,
                    'view_count': entry.get('view_count'),
                    'url': entry.get('url') or f"https://www.youtube.com/watch?v={entry.get('id')}"
                })
                
        return {
            "status": "success",
            "results": results
        }
        
    except Exception as e:
        import traceback
        print(f"Search error: {e}\n{traceback.format_exc()}")
        raise HTTPException(status_code=500, detail=str(e))
