import React, { useState, useEffect } from 'react';
import { Search, Download, Music, AlertCircle, CheckCircle, ArrowRight, Settings, Upload, FileText, Check, Scissors, Sliders, Zap, Edit, Image as ImageIcon, X, Clock, Trash2, FolderOpen } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import axios from 'axios';

function App() {
  // Step: 'search' | 'confirm' | 'downloading' | 'result'
  const [step, setStep] = useState('search');
  const [url, setUrl] = useState('');
  const [resolvedUrl, setResolvedUrl] = useState(''); // Valid YouTube URL after magic search
  const [metadata, setMetadata] = useState(null);
  const [quality, setQuality] = useState('320'); // Default: Ultra MP3
  const [mode, setMode] = useState('audio'); // 'audio' | 'video'
  const [playlist, setPlaylist] = useState(false); // Baixar playlist inteira?
  const [loading, setLoading] = useState(false);
  const [status, setStatus] = useState(null); // 'success', 'error'
  const [message, setMessage] = useState('');
  const [downloadInfo, setDownloadInfo] = useState(null);

  // Trim State
  const [trim, setTrim] = useState(false);
  const [startTime, setStartTime] = useState('');
  const [endTime, setEndTime] = useState('');

  // Audio Features
  const [pitch, setPitch] = useState(0); // -12 to +12
  const [speed, setSpeed] = useState(1.0); // 0.5 to 2.0
  const [eqPreset, setEqPreset] = useState(null); // 'bass', 'soft', 'treble', 'vocal'

  // Metadata Edit State
  const [showEdit, setShowEdit] = useState(false);
  const [editTitle, setEditTitle] = useState('');
  const [editArtist, setEditArtist] = useState('');
  const [coverPreview, setCoverPreview] = useState(null);
  const [coverPath, setCoverPath] = useState(null);

  // Auth & Settings
  const [showSettings, setShowSettings] = useState(false);
  const [showHistory, setShowHistory] = useState(false);
  const [history, setHistory] = useState([]);
  const [isAuthenticated, setIsAuthenticated] = useState(false);

  // Playlist Manager
  const [showPlaylistModal, setShowPlaylistModal] = useState(false);
  const [playlistVideos, setPlaylistVideos] = useState([]);
  const [selectedVideos, setSelectedVideos] = useState(new Set());
  const [playlistLoading, setPlaylistLoading] = useState(false);
  const [playlistProgress, setPlaylistProgress] = useState({});

  React.useEffect(() => {
    checkAuth();
  }, []);

  const checkAuth = async () => {
    try {
      const res = await axios.get('http://localhost:8000/auth_status');
      setIsAuthenticated(res.data.authenticated);
    } catch (e) {
      console.error("Auth check failed", e);
    }
  };

  // Reset quality when mode changes
  React.useEffect(() => {
    if (mode === 'audio') {
      setQuality('320');
    } else {
      // Default to highest available if metadata exists
      if (metadata?.resolutions?.length > 0) {
        setQuality(`${metadata.resolutions[0]}p`);
      } else {
        setQuality('720p');
      }
    }
  }, [mode, metadata]);

  // Sync Metadata to Edit State
  useEffect(() => {
    if (metadata) {
      setEditTitle(metadata.title || '');
      setEditArtist(metadata.artist || ''); // yt-dlp might not return artist always in info
      setCoverPreview(metadata.thumbnail);
      setCoverPath(null);
      setShowEdit(false);
    }
  }, [metadata]);

  const handleCoverUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);

    try {
      const res = await axios.post('http://localhost:8000/upload_cover', formData);
      setCoverPath(res.data.path);
      setCoverPreview(URL.createObjectURL(file));
    } catch (e) {
      console.error(e);
      alert("Erro ao enviar imagem");
    }
  };

  const fetchHistory = async () => {
    try {
      const res = await axios.get('http://localhost:8000/history');
      setHistory(res.data);
    } catch (e) {
      console.error("Erro ao buscar hist√≥rico", e);
    }
  };

  const clearHistory = async () => {
    if (confirm("Limpar todo o hist√≥rico?")) {
      await axios.delete('http://localhost:8000/history');
      setHistory([]);
    }
  };

  const fetchInfo = async (e) => {
    e.preventDefault();
    if (!url) return;

    setLoading(true);
    setMessage('');
    try {
      const response = await axios.post('http://localhost:8000/info', { url });
      setMetadata(response.data);
      setStep('confirm');
    } catch (error) {
      console.error(error);
      setStatus('error');
      // Show actual backend error if available
      const errorMsg = error.response?.data?.detail || 'N√£o foi poss√≠vel encontrar essa m√∫sica. Verifique o link.';
      setMessage(errorMsg);
      setTimeout(() => setStatus(null), 5000); // 5s to read
    } finally {
      setLoading(false);
    }
  };

  const handleDownload = async () => {
    setStep('downloading');
    setStatus(null);
    setMessage('');

    try {
      const response = await axios.post('http://localhost:8000/download', {
        url: metadata.url,
        quality,
        mode,
        playlist,
        start_time: trim ? startTime : null,
        end_time: trim ? endTime : null,
        start_time: trim ? startTime : null,
        end_time: trim ? endTime : null,
        pitch: mode === 'audio' ? pitch : 0,
        speed: mode === 'audio' ? speed : 1.0,
        eq_preset: mode === 'audio' ? eqPreset : null,
        title: editTitle !== metadata.title ? editTitle : null,
        artist: editArtist,
        cover_path: coverPath
      });
      setStatus('success');
      setDownloadInfo(response.data);
      setMessage(`Download conclu√≠do!`);
      setStep('result');
    } catch (error) {
      console.error(error);
      setStatus('error');
      setMessage('Falha no download. O servidor pode estar ocupado.');
      setStep('confirm'); // Volta para tentar de novo
    }
  };

  // Polling de Progresso
  React.useEffect(() => {
    let interval;
    if (step === 'downloading') {
      const poll = async () => {
        try {
          const res = await axios.get('http://localhost:8000/progress');
          setProgress(res.data);
        } catch (e) {
          console.error(e);
        }
      };

      interval = setInterval(poll, 500); // Checa a cada meio segundo
    }
    return () => clearInterval(interval);
  }, [step]);

  const [progress, setProgress] = useState({ percent: 0, status: 'idle' });

  // ... (reset function needs to clear progress too)
  const reset = () => {
    setStep('search');
    setUrl('');
    setMetadata(null);
    setStatus(null);
    setMessage('');
    setProgress({ percent: 0, status: 'idle' }); // Reset
    setMode('audio');
  };

  return (
    <div className="min-h-screen bg-background text-white flex flex-col items-center justify-center p-4 font-sans selection:bg-primary selection:text-white relative">
      <div className="absolute top-4 right-4 z-50">
        <button
          onClick={() => { setShowHistory(true); fetchHistory(); }}
          className="flex items-center gap-2 px-4 py-2 mr-2 rounded-full font-medium shadow-lg backdrop-blur-md bg-surface/50 text-secondary border border-white/10 hover:bg-surface transition-all"
        >
          <Clock className="w-4 h-4" />
          Hist√≥rico
        </button>
        <button
          onClick={() => setShowSettings(true)}
          className={`flex items-center gap-2 px-4 py-2 rounded-full font-medium shadow-lg backdrop-blur-md transition-all ${isAuthenticated ? 'bg-green-500/20 text-green-300 border border-green-500/30' : 'bg-surface/50 text-secondary border border-white/10 hover:bg-surface'}`}
        >
          {isAuthenticated ? <CheckCircle className="w-4 h-4" /> : <Settings className="w-4 h-4" />}
          {isAuthenticated ? 'Conectado' : 'Configurar'}
        </button>
      </div>

      <SettingsModal
        isOpen={showSettings}
        onClose={() => setShowSettings(false)}
        isAuthenticated={isAuthenticated}
        onUploadSuccess={() => {
          checkAuth();
          alert("Cookies atualizados com sucesso!");
          setShowSettings(false);
        }}
      />

      <HistoryModal
        isOpen={showHistory}
        onClose={() => setShowHistory(false)}
        history={history}
        onClear={clearHistory}
      />

      {/* Background Decor */}
      <div className="fixed inset-0 z-0 overflow-hidden pointer-events-none">
        <div className="absolute top-[-10%] left-[-10%] w-96 h-96 bg-primary/20 rounded-full blur-[128px]" />
        <div className="absolute bottom-[-10%] right-[-10%] w-96 h-96 bg-purple-600/20 rounded-full blur-[128px]" />
      </div>

      <div className="z-10 w-full max-w-xl space-y-8">

        {/* Header */}
        <motion.div
          layout
          className="text-center space-y-2"
        >
          <div className="inline-flex items-center justify-center p-3 rounded-2xl bg-surface border border-white/10 mb-4 shadow-xl">
            <Music className="w-8 h-8 text-primary" />
          </div>
          <h1 className="text-4xl font-bold tracking-tight bg-gradient-to-r from-white to-secondary bg-clip-text text-transparent">
            Music Downloader
          </h1>
          <p className="text-secondary text-lg">
            {step === 'search' ? 'Cole seu link de qualquer plataforma.' : 'Configure seu download.'}
          </p>
        </motion.div>

        <AnimatePresence mode="wait">

          {/* STEP 1: BUSCA */}
          {step === 'search' && (
            <motion.form
              key="search-form"
              initial={{ opacity: 0, x: -20 }}
              animate={{ opacity: 1, x: 0 }}
              exit={{ opacity: 0, x: -20 }}
              onSubmit={fetchInfo}
              className="relative group space-y-4"
            >
              <div className="relative">
                <div className="absolute inset-y-0 left-4 flex items-center pointer-events-none">
                  <Search className="w-5 h-5 text-secondary group-focus-within:text-primary transition-colors" />
                </div>
                <input
                  type="text"
                  placeholder="Cole o link do YouTube, Twitch, Kick, SoundCloud..."
                  className="w-full h-14 pl-12 pr-4 bg-surface/50 backdrop-blur-md border border-white/10 rounded-2xl focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all text-lg placeholder:text-secondary/50 shadow-lg"
                  value={url}
                  onChange={(e) => setUrl(e.target.value)}
                  autoFocus
                />
              </div>

              <button
                type="submit"
                disabled={loading || !url}
                className="w-full h-12 bg-primary hover:bg-blue-600 disabled:bg-surface disabled:text-secondary rounded-xl font-medium transition-all flex items-center justify-center gap-2 shadow-lg disabled:shadow-none"
              >
                {loading ? (
                  <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin" />
                ) : (
                  <>
                    <span>Buscar Detalhes</span>
                    <ArrowRight className="w-4 h-4" />
                  </>
                )}
              </button>

              <div className="flex justify-center gap-4 text-xs text-secondary/50 font-medium pt-2">
                <span className="flex items-center gap-1 hover:text-white transition-colors"><div className="w-1.5 h-1.5 rounded-full bg-red-500" />YouTube</span>
                <span className="flex items-center gap-1 hover:text-white transition-colors"><div className="w-1.5 h-1.5 rounded-full bg-purple-500" />Twitch</span>
                <span className="flex items-center gap-1 hover:text-white transition-colors"><div className="w-1.5 h-1.5 rounded-full bg-green-500" />Kick</span>
                <span className="flex items-center gap-1 hover:text-white transition-colors"><div className="w-1.5 h-1.5 rounded-full bg-orange-500" />SoundCloud</span>
              </div>
            </motion.form>
          )}

          {/* STEP 2: CONFIRMA√á√ÉO / RESULTADO */}
          {(step === 'confirm' || step === 'downloading' || step === 'result') && metadata && (
            <motion.div
              key="confirm-card"
              initial={{ opacity: 0, scale: 0.95 }}
              animate={{ opacity: 1, scale: 1 }}
              exit={{ opacity: 0, scale: 0.95 }}
              className="bg-surface/50 backdrop-blur-md border border-white/10 rounded-3xl p-6 shadow-2xl space-y-6"
            >
              {/* Media Info & Editor */}
              {!showEdit ? (
                <div className="flex gap-4 items-center relative group">
                  <div className="relative">
                    {coverPreview ? (
                      <img src={coverPreview} alt="Cover" className="w-20 h-20 rounded-xl object-cover shadow-lg" />
                    ) : (
                      <div className="w-20 h-20 bg-black/40 rounded-xl flex items-center justify-center">
                        <Music className="w-8 h-8 text-secondary" />
                      </div>
                    )}
                  </div>

                  <div className="flex-1 min-w-0">
                    <h3 className="font-bold text-lg leading-tight line-clamp-2 text-white">{editTitle || metadata.title}</h3>
                    <p className="text-secondary text-sm mt-1">{editArtist || 'Pronto para baixar'}</p>
                    {metadata.magic_source && (
                      <div className="flex items-center gap-1 mt-1 text-[10px] bg-green-500/20 text-green-400 px-2 py-0.5 rounded-full w-fit">
                        <span>ü™Ñ Convertido de {metadata.magic_source}</span>
                      </div>
                    )}
                  </div>

                  <button
                    onClick={() => setShowEdit(true)}
                    className="p-2 bg-surface hover:bg-white/10 rounded-full text-secondary hover:text-white transition-colors"
                    title="Editar Informa√ß√µes"
                  >
                    <Edit className="w-5 h-5" />
                  </button>
                </div>
              ) : (
                <div className="bg-surface/50 border border-white/10 rounded-2xl p-4 space-y-4 animate-in fade-in zoom-in-95 duration-200">
                  <div className="flex justify-between items-center mb-2">
                    <span className="text-sm font-bold text-white flex items-center gap-2">
                      <Edit className="w-4 h-4 text-primary" />
                      Editor de Metadados
                    </span>
                    <button onClick={() => setShowEdit(false)} className="text-secondary hover:text-white">
                      <X className="w-5 h-5" />
                    </button>
                  </div>

                  <div className="flex gap-4">
                    {/* Image Upload */}
                    <div className="relative group w-24 h-24 flex-shrink-0">
                      <img src={coverPreview || metadata.thumbnail} className="w-full h-full object-cover rounded-xl border border-white/10" />
                      <label className="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex flex-col items-center justify-center rounded-xl cursor-pointer transition-all">
                        <ImageIcon className="w-6 h-6 text-white mb-1" />
                        <span className="text-[10px] text-white font-medium">Alterar</span>
                        <input type="file" accept="image/*" className="hidden" onChange={handleCoverUpload} />
                      </label>
                    </div>

                    {/* Inputs */}
                    <div className="flex-1 space-y-3">
                      <div>
                        <label className="text-xs text-secondary/70 ml-1 mb-1 block">T√≠tulo</label>
                        <input
                          type="text"
                          value={editTitle}
                          onChange={(e) => setEditTitle(e.target.value)}
                          className="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:border-primary outline-none"
                          placeholder="Nome da M√∫sica"
                        />
                      </div>
                      <div>
                        <label className="text-xs text-secondary/70 ml-1 mb-1 block">Artista</label>
                        <input
                          type="text"
                          value={editArtist}
                          onChange={(e) => setEditArtist(e.target.value)}
                          className="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-sm text-white focus:border-primary outline-none"
                          placeholder="Nome do Artista"
                        />
                      </div>
                    </div>
                  </div>

                  <button
                    onClick={() => setShowEdit(false)}
                    className="w-full py-2 bg-primary/20 hover:bg-primary/30 text-primary rounded-lg text-sm font-medium transition-colors"
                  >
                    Confirmar Altera√ß√µes
                  </button>
                </div>
              )}

              {step === 'confirm' && (
                <div className="space-y-4">
                  {/* Playlist Toggle */}
                  {metadata.is_playlist && (
                    <div className="bg-purple-500/10 border border-purple-500/20 rounded-xl p-4 flex items-center justify-between mb-2">
                      <div className="flex items-center gap-3">
                        <div className="p-2 bg-purple-500/20 rounded-lg">
                          <FileText className="w-5 h-5 text-purple-400" />
                        </div>
                        <div>
                          <h4 className="font-bold text-white">Playlist Detectada</h4>
                          <p className="text-xs text-secondary">Este v√≠deo faz parte de uma playlist.</p>
                        </div>
                      </div>
                      <div className="flex items-center gap-2">
                        <span className={`text-sm font-medium ${!playlist ? 'text-white' : 'text-secondary'}`}>Apenas este</span>
                        <button
                          onClick={() => setPlaylist(!playlist)}
                          className={`w-12 h-6 rounded-full transition-colors relative ${playlist ? 'bg-purple-500' : 'bg-surface border border-white/10'}`}
                        >
                          <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform ${playlist ? 'translate-x-6' : 'translate-x-0'}`} />
                        </button>
                        <span className={`text-sm font-medium ${playlist ? 'text-white' : 'text-secondary'}`}>Tudo</span>
                      </div>
                    </div>
                  )}

                  {/* Trim Toggle */}
                  <div className="bg-blue-500/5 border border-blue-500/10 rounded-xl p-4 mb-2">
                    <div className="flex items-center justify-between mb-3">
                      <div className="flex items-center gap-2">
                        <Scissors className="w-5 h-5 text-blue-400" />
                        <span className="font-bold text-white">Recortar Trecho</span>
                      </div>
                      <button
                        onClick={() => {
                          const newTrim = !trim;
                          setTrim(newTrim);
                          if (newTrim) {
                            if (!startTime) setStartTime("00:00");
                            if (!endTime && metadata.duration_string) setEndTime(metadata.duration_string);
                          }
                        }}
                        className={`w-12 h-6 rounded-full transition-colors relative ${trim ? 'bg-blue-500' : 'bg-surface border border-white/10'}`}
                      >
                        <div className={`absolute top-1 left-1 w-4 h-4 bg-white rounded-full transition-transform ${trim ? 'translate-x-6' : 'translate-x-0'}`} />
                      </button>
                    </div>

                    <AnimatePresence>
                      {trim && (
                        <motion.div
                          initial={{ height: 0, opacity: 0 }}
                          animate={{ height: 'auto', opacity: 1 }}
                          exit={{ height: 0, opacity: 0 }}
                          className="overflow-hidden"
                        >
                          <div className="flex gap-4 pt-2">
                            <div className="flex-1">
                              <label className="text-xs text-secondary mb-1 block">In√≠cio (MM:SS ou S)</label>
                              <input
                                type="text"
                                placeholder="00:00"
                                className="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white text-center font-mono focus:border-blue-500 outline-none"
                                value={startTime}
                                onChange={(e) => setStartTime(e.target.value)}
                              />
                            </div>
                            <div className="flex-1">
                              <label className="text-xs text-secondary mb-1 block">Fim (MM:SS ou S)</label>
                              <input
                                type="text"
                                placeholder="00:00"
                                className="w-full bg-black/20 border border-white/10 rounded-lg px-3 py-2 text-white text-center font-mono focus:border-blue-500 outline-none"
                                value={endTime}
                                onChange={(e) => setEndTime(e.target.value)}
                              />
                            </div>
                          </div>
                        </motion.div>
                      )}
                    </AnimatePresence>
                  </div>

                  {/* Mode Toggle */}
                  <div className="flex bg-surface/50 p-1 rounded-xl">
                    <button
                      onClick={() => setMode('audio')}
                      className={`flex-1 py-2 rounded-lg text-sm font-semibold transition-all ${mode === 'audio' ? 'bg-primary text-white shadow-lg' : 'text-secondary hover:text-white'
                        }`}
                    >
                      üéµ √Åudio
                    </button>
                    <button
                      onClick={() => setMode('video')}
                      className={`flex-1 py-2 rounded-lg text-sm font-semibold transition-all ${mode === 'video' ? 'bg-primary text-white shadow-lg' : 'text-secondary hover:text-white'
                        }`}
                    >
                      üé¨ V√≠deo
                    </button>
                  </div>

                  {/* Audio Features (Pitch) - Only for Audio */}
                  {mode === 'audio' && (
                    <div className="bg-surface/30 border border-white/5 rounded-xl p-4 space-y-3">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <Sliders className="w-5 h-5 text-purple-400" />
                          <span className="font-semibold text-white">Tom (Transposi√ß√£o)</span>
                        </div>
                        <span className={`text-sm font-mono font-bold ${pitch === 0 ? 'text-secondary' : 'text-purple-400'}`}>
                          {pitch > 0 ? `+${pitch}` : pitch} Semitons
                        </span>
                      </div>
                      <input
                        type="range"
                        min="-12"
                        max="12"
                        step="1"
                        value={pitch}
                        onChange={(e) => setPitch(parseInt(e.target.value))}
                        className="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-purple-500"
                      />
                      <div className="flex justify-between text-[10px] text-secondary/50 font-mono px-1">
                        <span>-12</span>
                        <span>0</span>
                        <span>+12</span>
                      </div>
                    </div>
                  )}

                  {/* Speed Control */}
                  {mode === 'audio' && (
                    <div className="bg-surface/30 border border-white/5 rounded-xl p-4 space-y-3 mb-6">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-2">
                          <Zap className="w-5 h-5 text-yellow-400" />
                          <span className="font-semibold text-white">Velocidade (Nightcore/Slowed)</span>
                        </div>
                        <span className={`text-sm font-mono font-bold ${speed === 1.0 ? 'text-secondary' : 'text-yellow-400'}`}>
                          {speed}x
                        </span>
                      </div>
                      <input
                        type="range"
                        min="0.5"
                        max="2.0"
                        step="0.05"
                        value={speed}
                        onChange={(e) => setSpeed(parseFloat(e.target.value))}
                        className="w-full h-2 bg-white/10 rounded-lg appearance-none cursor-pointer accent-yellow-500"
                      />
                      <div className="flex justify-between text-[10px] text-secondary/50 font-mono px-1">
                        <span>0.5x</span>
                        <span>1.0x</span>
                        <span>2.0x</span>
                      </div>
                    </div>
                  )}

                  {/* Equalizer */}
                  {mode === 'audio' && (
                    <div className="bg-surface/30 border border-white/5 rounded-xl p-4 space-y-3 mb-6">
                      <div className="flex items-center gap-2 mb-2">
                        <span className="font-semibold text-white">Equalizador</span>
                      </div>
                      <div className="grid grid-cols-2 gap-2">
                        {[
                          { id: 'bass', label: 'Bass Boost', icon: 'üîä' },
                          { id: 'soft', label: 'Suave', icon: '‚òÅÔ∏è' },
                          { id: 'treble', label: 'Agudos', icon: 'üéª' },
                          { id: 'vocal', label: 'Vocal', icon: 'üé§' }
                        ].map((preset) => (
                          <button
                            key={preset.id}
                            onClick={() => setEqPreset(eqPreset === preset.id ? null : preset.id)}
                            className={`p-2 rounded-lg text-sm font-medium transition-all flex items-center gap-2 border ${eqPreset === preset.id
                              ? 'bg-primary/20 border-primary text-primary'
                              : 'bg-white/5 border-transparent text-secondary hover:bg-white/10'
                              }`}
                          >
                            <span>{preset.icon}</span>
                            {preset.label}
                            {eqPreset === preset.id && <Check className="w-3 h-3 ml-auto" />}
                          </button>
                        ))}
                      </div>
                    </div>
                  )}

                  <div>
                    <label className="text-xs font-semibold text-secondary uppercase tracking-wider mb-2 block">
                      Qualidade ({mode === 'audio' ? '√Åudio' : 'V√≠deo'})
                    </label>
                    <div className="grid grid-cols-1 gap-2">
                      {mode === 'audio' ? (
                        <>
                          <QualityOption
                            id="320"
                            label="üî• Ultra MP3"
                            sub="320kbps ‚Ä¢ Est√∫dio"
                            selected={quality}
                            set={setQuality}
                          />
                          <QualityOption
                            id="high"
                            label="üéµ Alta Qualidade"
                            sub="192kbps ‚Ä¢ Padr√£o Spotify"
                            selected={quality}
                            set={setQuality}
                          />
                          <QualityOption
                            id="medium"
                            label="üìâ Economia de Dados"
                            sub="128kbps ‚Ä¢ Leve"
                            selected={quality}
                            set={setQuality}
                          />
                          <QualityOption
                            id="flac"
                            label="üéß Lossless FLAC"
                            sub="Sem compress√£o"
                            selected={quality}
                            set={setQuality}
                          />
                          <QualityOption
                            id="best"
                            label="üíé Original"
                            sub="M4A/Opus sem convers√£o"
                            selected={quality}
                            set={setQuality}
                          />
                        </>
                      ) : (
                        <>
                          {metadata.resolutions && metadata.resolutions.length > 0 ? (
                            metadata.resolutions.map((res) => {
                              let label = `üé• ${res}p`;
                              let sub = "Qualidade Padr√£o";
                              if (res >= 2160) { label = "üíé 4K Ultra HD"; sub = "Defini√ß√£o M√°xima (WebM/MKV)"; }
                              else if (res >= 1440) { label = "‚ú® 2K Quad HD"; sub = "Alta Defini√ß√£o Superior"; }
                              else if (res >= 1080) { label = "üé¨ Full HD 1080p"; sub = "Padr√£o MP4"; }
                              else if (res >= 720) { label = "üì± HD 720p"; sub = "Leve e R√°pido (MP4)"; }
                              else if (res >= 480) { label = "üì∫ 480p"; sub = "Qualidade DVD"; }
                              else { label = `üì∫ ${res}p`; sub = "Economia de Dados"; }

                              return (
                                <QualityOption
                                  key={res}
                                  id={`${res}p`}
                                  label={label}
                                  sub={sub}
                                  selected={quality}
                                  set={setQuality}
                                />
                              );
                            })
                          ) : (
                            <div className="p-4 bg-red-500/10 border border-red-500/20 rounded-xl text-center">
                              <p className="text-red-300 text-sm font-medium">Nenhuma qualidade de v√≠deo encontrada.</p>
                            </div>
                          )}
                        </>
                      )}
                    </div>
                  </div>

                  <div className="flex gap-3 pt-2">
                    <button
                      onClick={reset}
                      className="px-4 py-3 rounded-xl hover:bg-white/5 text-secondary font-medium transition-colors"
                    >
                      Cancelar
                    </button>
                    <button
                      onClick={handleDownload}
                      className="flex-1 bg-primary hover:bg-blue-600 rounded-xl font-boldshadow-lg flex items-center justify-center gap-2 transition-all"
                    >
                      <Download className="w-5 h-5" />
                      Baixar Agora
                    </button>
                  </div>
                </div>
              )}

              {step === 'downloading' && (
                <div className="py-6 text-center space-y-4">
                  <div className="relative w-full h-4 bg-white/10 rounded-full overflow-hidden">
                    <motion.div
                      initial={{ width: 0 }}
                      animate={{ width: `${progress.percent}%` }}
                      transition={{ ease: "linear" }}
                      className="absolute h-full bg-primary"
                    />
                  </div>

                  <div className="flex justify-between text-sm text-secondary px-1">
                    <span>
                      {progress.percent < 99
                        ? 'Baixando...'
                        : 'Processando (Mixagem/Capa)...'}
                    </span>
                    <span className="font-mono">{Math.round(progress.percent)}%</span>
                  </div>

                  <p className="text-xs text-secondary/50">
                    {progress.percent === 100 ? 'Quase l√°, finalizando o arquivo...' : 'Aguarde um momento'}
                  </p>
                </div>
              )}

              {step === 'result' && (
                <div className="py-4 text-center space-y-4 bg-green-500/10 rounded-2xl border border-green-500/20">
                  <div className="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center mx-auto shadow-lg shadow-green-500/30">
                    <CheckCircle className="w-6 h-6 text-white" />
                  </div>
                  <div>
                    <h3 className="font-bold text-green-400">Sucesso!</h3>
                    <p className="text-green-200/80 text-sm px-4 break-all">{downloadInfo?.file}</p>
                    <p className="text-xs text-green-200/50 mt-1">Salvo na pasta downloads</p>
                  </div>
                  <div className="flex gap-2 justify-center mt-4">
                    <button
                      onClick={reset}
                      className="px-6 py-2 bg-surface hover:bg-white/10 rounded-xl text-sm font-medium transition-colors"
                    >
                      Baixar Outra
                    </button>
                    <button
                      onClick={() => axios.post('http://localhost:8000/open_folder')}
                      className="px-6 py-2 bg-white/10 hover:bg-white/20 rounded-xl text-sm font-medium transition-colors flex items-center gap-2"
                    >
                      üìÇ Abrir Pasta
                    </button>
                  </div>
                </div>
              )}

            </motion.div>
          )}

        </AnimatePresence>

        {/* Global Error Toast */}
        <AnimatePresence>
          {status === 'error' && (
            <motion.div
              initial={{ opacity: 0, y: 20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: 20 }}
              className="fixed bottom-8 left-1/2 -translate-x-1/2 bg-red-900/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-2xl border border-red-500/30 flex items-center gap-3 z-50"
            >
              <AlertCircle className="w-5 h-5 text-red-400" />
              <span className="font-medium">{message}</span>
            </motion.div>
          )}
        </AnimatePresence>

      </div>

      <div className="fixed bottom-4 text-xs text-secondary/30 hover:text-secondary transition-colors">
        <a href="https://github.com/Echiiiro453" target="_blank" rel="noopener noreferrer" className="flex items-center gap-1">
          Desenvolvido por Echiiiro453
        </a>
      </div>
    </div>
  );
}

function SettingsModal({ isOpen, onClose, isAuthenticated, onUploadSuccess }) {
  if (!isOpen) return null;

  const handleFileUpload = async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (file.name !== 'cookies.txt') {
      alert("O arquivo deve se chamar exatamente 'cookies.txt'");
      return;
    }

    const formData = new FormData();
    formData.append('file', file);

    try {
      await axios.post('http://localhost:8000/upload_cookies', formData, {
        headers: { 'Content-Type': 'multipart/form-data' }
      });
      onUploadSuccess();
    } catch (error) {
      alert("Erro ao enviar arquivo. Verifique o console.");
      console.error(error);
    }
  };

  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
      <motion.div
        initial={{ opacity: 0, scale: 0.9 }}
        animate={{ opacity: 1, scale: 1 }}
        className="bg-[#121214] border border-white/10 rounded-2xl w-full max-w-md p-6 shadow-2xl relative"
      >
        <button onClick={onClose} className="absolute top-4 right-4 text-secondary hover:text-white">X</button>

        <div className="flex items-center gap-3 mb-6">
          <div className="p-3 bg-surface rounded-xl">
            <Settings className="w-6 h-6 text-primary" />
          </div>
          <h2 className="text-xl font-bold text-white">Configura√ß√£o</h2>
        </div>

        <div className="space-y-4">
          {/* Status Card */}
          <div className={`p-4 rounded-xl border ${isAuthenticated ? 'bg-green-500/10 border-green-500/30' : 'bg-red-500/10 border-red-500/30'}`}>
            <div className="flex items-center gap-3">
              {isAuthenticated ? <CheckCircle className="text-green-400" /> : <AlertCircle className="text-red-400" />}
              <div>
                <h3 className={`font-bold ${isAuthenticated ? 'text-green-400' : 'text-red-400'}`}>
                  {isAuthenticated ? 'Sistema Autenticado' : 'N√£o Autenticado'}
                </h3>
                <p className="text-sm text-secondary/80">
                  {isAuthenticated ? 'Voc√™ pode baixar v√≠deos em alta qualidade.' : 'Downloads podem falhar (Erro 403).'}
                </p>
              </div>
            </div>
          </div>

          {/* Tutorial Clean */}
          <div className="space-y-3 pt-2">
            <p className="text-sm font-semibold text-white">Como autenticar:</p>
            <ol className="space-y-2 text-sm text-secondary list-decimal pl-4">
              <li>Instale a extens√£o <b>Get cookies.txt LOCALLY</b>.</li>
              <li>V√° no YouTube e exporte os cookies.</li>
              <li>Renomeie o arquivo para <b>cookies.txt</b>.</li>
              <li>Envie o arquivo abaixo:</li>
            </ol>
          </div>

          {/* Upload Area */}
          <div className="relative group">
            <input
              type="file"
              accept=".txt"
              onChange={handleFileUpload}
              className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"
            />
            <div className="border-2 border-dashed border-white/10 group-hover:border-primary/50 group-hover:bg-primary/5 rounded-xl p-6 flex flex-col items-center justify-center transition-all text-center gap-2">
              <Upload className="w-8 h-8 text-secondary group-hover:text-primary transition-colors" />
              <p className="text-sm font-medium text-white">Clique para enviar cookies.txt</p>
              <p className="text-xs text-secondary">Apenas arquivos .txt</p>
            </div>
          </div>

        </div>

      </motion.div>
    </div>
  )
}

function QualityOption({ id, label, sub, selected, set }) {
  const isSelected = selected === id;
  return (
    <button
      onClick={() => set(id)}
      className={`w-full text-left px-4 py-3 rounded-xl border transition-all flex items-center justify-between group ${isSelected
        ? 'bg-primary/10 border-primary shadow-[0_0_20px_rgba(59,130,246,0.2)]'
        : 'bg-surface/50 border-white/5 hover:border-white/10 hover:bg-surface'
        }`}
    >
      <div>
        <p className={`font-semibold ${isSelected ? 'text-primary' : 'text-white'}`}>{label}</p>
        <p className="text-xs text-secondary">{sub}</p>
      </div>
      {isSelected && (
        <motion.div layoutId="check">
          <CheckCircle className="w-5 h-5 text-primary" />
        </motion.div>
      )}
    </button>
  )
}

function HistoryModal({ isOpen, onClose, history, onClear }) {
  if (!isOpen) return null;
  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
      <motion.div
        initial={{ opacity: 0, scale: 0.9 }}
        animate={{ opacity: 1, scale: 1 }}
        className="bg-[#121214] border border-white/10 rounded-2xl w-full max-w-lg p-6 shadow-2xl relative max-h-[80vh] flex flex-col"
      >
        <button onClick={onClose} className="absolute top-4 right-4 text-secondary hover:text-white">X</button>

        <div className="flex items-center justify-between mb-6">
          <div className="flex items-center gap-3">
            <div className="p-3 bg-surface rounded-xl">
              <Clock className="w-6 h-6 text-primary" />
            </div>
            <h2 className="text-xl font-bold text-white">Hist√≥rico</h2>
          </div>
          {history.length > 0 && (
            <button onClick={onClear} className="text-red-400 hover:text-red-300 text-sm flex items-center gap-1">
              <Trash2 className="w-4 h-4" /> Limpar
            </button>
          )}
        </div>

        <div className="flex-1 overflow-y-auto space-y-3 pr-2 custom-scrollbar">
          {history.length === 0 ? (
            <div className="text-center py-10 text-secondary">
              <Clock className="w-12 h-12 mx-auto mb-3 opacity-20" />
              <p>Nenhum download recente.</p>
            </div>
          ) : (
            history.map((item, i) => (
              <div key={i} className="flex gap-3 p-3 bg-surface/30 hover:bg-surface/50 rounded-xl border border-white/5 transition-colors group">
                <img src={item.thumbnail} className="w-12 h-12 rounded-lg object-cover bg-black/50" />
                <div className="flex-1 min-w-0">
                  <h4 className="text-white font-medium text-sm truncate">{item.title}</h4>
                  <p className="text-secondary/70 text-xs truncate">{item.artist || 'Desconhecido'}</p>
                  <div className="flex gap-2 mt-1">
                    <span className="text-[10px] px-1.5 py-0.5 bg-white/5 rounded text-secondary">{item.quality}</span>
                    <span className="text-[10px] px-1.5 py-0.5 bg-white/5 rounded text-secondary">{new Date(item.timestamp).toLocaleDateString()}</span>
                  </div>
                </div>
                <button
                  onClick={() => axios.post('http://localhost:8000/open_folder')}
                  className="p-2 text-secondary hover:text-primary transition-colors"
                  title="Abrir Pasta"
                >
                  <FolderOpen className="w-5 h-5" />
                </button>
              </div>
            ))
          )}
        </div>
      </motion.div>
    </div>
  );
}

export default App;
